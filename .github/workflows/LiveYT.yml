name: Get YouTube Channel Live to m3u8

on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install yt-dlp
        run: |
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp

      - name: Get Channel Live Stream URL
        run: |
          touch ./channel_live.m3u8
          sudo cat >./channel_live.m3u8 <<EOL
          #EXTM3U
          #EXT-X-VERSION:3
          #EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=2560000
          $(yt-dlp -g https://www.youtube.com/channel/@MPLIndonesia/live)
          EOL

      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: YTlive m3u8
          path: channel_live.m3u8

      - name: Git push assets to "YTlive" branch
        run: |
          git init
          git config --local user.name "actions"
          git config --local user.email "action@github.com"
          git checkout -b YTlive
          git add channel_live.m3u8
          git commit -m "Update YTlive"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f -u origin YTlive
